---
title: CDH 6.2.1 离线部署
date: 2020-10-04 15:15:10
tags:
categories: 大数据
---

## 准备
由于网络问题，所有需要的软件包已下载并上传到自有对象存储服务

## 节点初始化

### hostname
```
hostnamectl set-hostname {hostname}
```

### hosts
```
vim /etc/hosts
{ip} {hostname}
```

### 禁用防火墙
```
systemctl disable firewalld
systemctl stop firewalld
```

### 禁用大页面压缩
```
echo never > /sys/kernel/mm/transparent_hugepage/defrag

echo never > /sys/kernel/mm/transparent_hugepage/enabled

echo "echo never > /sys/kernel/mm/transparent_hugepage/defrag" >> /etc/rc.local
echo "echo never > /sys/kernel/mm/transparent_hugepage/enabled" >> /etc/rc.local
```

### SELinux
```
# 查看
getenforce

# 如果返回结果是 enforcing 执行如下命令，否则跳过
vim /etc/selinux/config
SELINUX=permissive

# 重启服务器或执行如下命令生效
setenforce 0
```

### NTP
使用的腾讯云主机，自带该服务

## JDK 配置
```
mkdir /data/packages
wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/jdk-8u261-linux-x64.tar.gz -P /data/packages
mkdir /usr/java
tar zxvf /data/packages/jdk-8u261-linux-x64.tar.gz -C /usr/java
echo "export JAVA_HOME=/usr/java/jdk1.8.0_261" >> /etc/profile
source /etc/profile
echo "export PATH=${JAVA_HOME}/bin:${PATH}" >> /etc/profile
source /etc/profile
```

## MySQL (master)
[参考文档](https://docs.cloudera.com/documentation/enterprise/6/latest/topics/cm_ig_mysql.html#cmig_topic_5_5)
> 为了保证稳定性和高可用性，建议单独部署
```
# 卸载默认
rpm -qa | grep -i mariadb
rpm -e --nodeps {}

cd /data/packages
wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/mysql-5.7.31-1.el7.x86_64.rpm-bundle.tar
tar xvf mysql-5.7.31-1.el7.x86_64.rpm-bundle.tar

# 安装
rpm -ivh /data/packages/mysql-community-common-5.7.31-1.el7.x86_64.rpm
rpm -ivh /data/packages/mysql-community-libs-5.7.31-1.el7.x86_64.rpm
rpm -ivh /data/packages/mysql-community-client-5.7.31-1.el7.x86_64.rpm
rpm -ivh /data/packages/mysql-community-server-5.7.31-1.el7.x86_64.rpm

# 查看
systemctl status mysqld

# 启动
systemctl start mysqld

# 停止
systemctl stop mysqld

# 开机启动（可选）
systemctl enable mysqld

# 修改密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'SpV6)cu~zu6kglb2SJTL';

# 配置文件
/etc/my.cnf
```

### 创建数据库
```
# Cloudera Manager Server
mysql> CREATE DATABASE scm DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
mysql> GRANT ALL ON scm.* TO 'scm'@'%' IDENTIFIED BY '<password>';

# Hive Metastore Server
mysql> CREATE DATABASE metastore DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
mysql> GRANT ALL ON metastore.* TO 'hive'@'%' IDENTIFIED BY '<password>';

# Sentry Server
mysql> CREATE DATABASE sentry DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
mysql> GRANT ALL ON sentry.* TO 'sentry'@'%' IDENTIFIED BY '<password>';


# 查看权限
mysql> SHOW GRANTS FOR '<user>'@'%';

```


## MySQL JDBC Driver
```
cd /data/packages
wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/mysql-connector-java-5.1.49.tar.gz

tar zxvf mysql-connector-java-5.1.49.tar.gz

mkdir -p /usr/share/java/
cp /data/packages/mysql-connector-java-5.1.49/mysql-connector-java-5.1.49-bin.jar /usr/share/java/mysql-connector-java.jar
```

## CM
```
mkdir /opt/cloudera-manager
cd /opt/cloudera-manager

# agent
wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/cloudera-manager-agent-6.2.1-1426065.el7.x86_64.rpm

# daemons
wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/cloudera-manager-daemons-6.2.1-1426065.el7.x86_64.rpm

# server
wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/cloudera-manager-server-6.2.1-1426065.el7.x86_64.rpm

wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/cloudera-manager-server-db-2-6.2.1-1426065.el7.x86_64.rpm

# 安装 daemon & agent
rpm -ivh cloudera-manager-daemons-6.2.1-1426065.el7.x86_64.rpm
rpm -ivh cloudera-manager-agent-6.2.1-1426065.el7.x86_64.rpm --nodeps

# 修改 agent 节点配置
vim /etc/cloudera-scm-agent/config.ini
将 server_host 的值修改为 Master 的 Host

# agent 启动/查看/停止
systemctl start cloudera-scm-agent
systemctl status cloudera-scm-agent
systemctl stop cloudera-scm-agent

# 安装 server(master)
rpm -ivh cloudera-manager-server-6.2.1-1426065.el7.x86_64.rpm

# CM Server Database 配置(master)
/opt/cloudera/cm/schema/scm_prepare_database.sh [-h <host>] <databaseType> <databaseName> <databaseUser>

## 修改 db.properties
vim /etc/cloudera-scm-server/db.properties

com.cloudera.cmf.db.type=<mysql>
com.cloudera.cmf.db.host=<localhost>
com.cloudera.cmf.db.name=<scm>
com.cloudera.cmf.db.user=<scm>
com.cloudera.cmf.db.setupType=EXTERNAL
com.cloudera.cmf.db.password=<password>

# server 启动/查看/停止
systemctl start cloudera-scm-server
systemctl status cloudera-scm-server
systemctl stop cloudera-scm-server
```

## CDH
```
cd /opt/cloudera/parcel-repo

wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/CDH-6.2.1-1.cdh6.2.1.p0.4951328-el7.parcel

wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/CDH-6.2.1-1.cdh6.2.1.p0.4951328-el7.parcel.sha1

# 重命名
mv CDH-6.2.1-1.cdh6.2.1.p0.4951328-el7.parcel.sha1 CDH-6.2.1-1.cdh6.2.1.p0.4951328-el7.parcel.sha

wget https://packages-1251506165.cos.ap-shanghai.myqcloud.com/manifest.json
```

## CM Web
> 成功启动 CM Server后，登录Web UI，http://{ip}:7180，账号密码默认 admin/admin


### Recommended Cluster Hosts and Role Distribution
https://docs.cloudera.com/documentation/enterprise/6/latest/topics/cm_ig_host_allocations.html#host_role_assignments


## 虚拟内存设置（视具体情况而定）
```
sysctl vm.swappiness=10
echo 'vm.swappiness=10' >> /etc/sysctl.conf
```


## 文件下载
CM：https://archive.cloudera.com/cm6/6.2.1/redhat7/yum/RPMS/x86_64/
CDH：https://archive.cloudera.com/cdh6/6.2.1/parcels/


