---
title: 多进程 VS 多线程
date: 2018-04-26 17:55:43
category: Linux
tags:
---
## 多进程vs多线程
多进程模式最大的优点是稳定性高，一个子进程崩溃了，不影响主进程和其他子进程。（主进程挂了所有进程就全挂了，但是Master进程只负责分配任务，挂掉的概率低） 
多进程模式的缺点是创建进程的代价大，在内存和CPU的限制下，操作系统连调度都可能会有问题。 
多线程模式通常比多进程快一点，但有一个致命的缺点是任何一个子线程挂掉都可能直接造成整个进程崩溃，因为所有线程共享进程的内存。

多线程和多进程最大的不同在于，多进程中，同一个变量，单独存在于每个进程中，互不影响。而多线程中，所有变量由所有线程共享，所以，任何一个变量都可以被任何一个线程修改，因此，线程之间共享数据最大的危险在于多个线程同时更改一个变量导致数据混乱。

解决以上问题就需要给当前执行的代码上锁，当前线程获得锁后，其他线程不能同时执行，只能等待，直到锁被释放后，获得该锁以后才可以更改。当多个线程同时执行加锁时，只有一个线程能成功获取锁。 
获得锁的线程执行完后一定要释放锁，否则其他线程将永远等待，造成死线程。 
由于可以存在多个锁，不同的线程持有不同的锁，当试图获取对方持有的锁时，可能会造成死锁，导致多个线程全部挂起，使用时一定要小心。

## 计算密集型vsIO密集型
是否采用多任务的第二个考虑是任务的类型。我们可以把任务分为计算密集型和IO密集型。

计算密集型任务的特点是要进行大量的计算，消耗CPU资源，比如计算圆周率、对视频进行高清解码等等，全靠CPU的运算能力。这种计算密集型任务虽然也可以用多任务完成，但是任务越多，花在任务切换的时间就越多，CPU执行任务的效率就越低，所以，要最高效地利用CPU，计算密集型任务同时进行的数量应当等于CPU的核心数。

计算密集型任务由于主要消耗CPU资源，因此，代码运行效率至关重要。Python这样的脚本语言运行效率很低，完全不适合计算密集型任务。对于计算密集型任务，最好用C语言编写。

第二种任务的类型是IO密集型，涉及到网络、磁盘IO的任务都是IO密集型任务，这类任务的特点是CPU消耗很少，任务的大部分时间都在等待IO操作完成（因为IO的速度远远低于CPU和内存的速度）。对于IO密集型任务，任务越多，CPU效率越高，但也有一个限度。常见的大部分任务都是IO密集型任务，比如Web应用。

IO密集型任务执行期间，99%的时间都花在IO上，花在CPU上的时间很少，因此，用运行速度极快的C语言替换用Python这样运行速度极低的脚本语言，完全无法提升运行效率。对于IO密集型任务，最合适的语言就是开发效率最高（代码量最少）的语言，脚本语言是首选，C语言最差。

## 异步IO
考虑到CPU和IO之间巨大的速度差异，一个任务在执行的过程中大部分时间都在等待IO操作，单进程单线程模型会导致别的任务无法并行执行，因此，我们才需要多进程模型或者多线程模型来支持多任务并发执行。

现代操作系统对IO操作已经做了巨大的改进，最大的特点就是支持异步IO。如果充分利用操作系统提供的异步IO支持，就可以用单进程单线程模型来执行多任务，这种全新的模型称为事件驱动模型，Nginx就是支持异步IO的Web服务器，它在单核CPU上采用单进程模型就可以高效地支持多任务。在多核CPU上，可以运行多个进程（数量与CPU核心数相同），充分利用多核CPU。由于系统总的进程数量十分有限，因此操作系统调度非常高效。用异步IO编程模型来实现多任务是一个主要的趋势。

对应到Python语言，单线程的异步编程模型称为协程，有了协程的支持，就可以基于事件驱动编写高效的多任务程序